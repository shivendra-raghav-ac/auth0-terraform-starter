# ========================================
# CI Pipeline: Build, Test, Validate
# Runs on: All branches and Pull Requests
# Purpose: Fast feedback, no deployment
# ========================================

name: $(Date:yyyyMMdd)$(Rev:.r)-ci

trigger:
  branches:
    include:
      - '*'
  paths:
    include:
      - actions/**
      - modules/**
      - environments/**
      - azure-pipelines-ci.yml

pr:
  branches:
    include:
      - master
      - develop
  paths:
    include:
      - actions/**
      - modules/**
      - environments/**

pool:
  vmImage: 'ubuntu-latest'

variables:
  - group: terraform-common-axon-cic
  - name: NODE_VERSION
    value: '20.x'
  - name: TF_VERSION
    value: '1.13.3'

stages:
  # ========================================
  # Stage 1: Build TypeScript Actions
  # ========================================
  - stage: Build
    displayName: 'Build Actions'
    jobs:
      - job: BuildActions
        displayName: 'Build TypeScript Actions'
        steps:
          - task: NodeTool@0
            displayName: 'Install Node.js $(NODE_VERSION)'
            inputs:
              versionSpec: $(NODE_VERSION)

          - task: Cache@2
            displayName: 'Cache npm dependencies'
            inputs:
              key: 'npm | "$(Agent.OS)" | actions/package-lock.json'
              path: actions/node_modules
              restoreKeys: |
                npm | "$(Agent.OS)"

          - script: |
              set -euo pipefail
              cd actions
              echo "Installing dependencies..."
              npm ci
              echo "Building actions..."
              npm run build
            displayName: 'Build Actions'

          - script: |
              set -euo pipefail
              cd actions
              echo "Running unit tests..."
              npm test
            displayName: 'Run Unit Tests'

          - script: |
              set -euo pipefail
              cd actions
              echo "Generating test coverage..."
              npm run test:coverage || true
            displayName: 'Generate Coverage Report'

          - task: PublishCodeCoverageResults@1
            displayName: 'Publish Coverage Results'
            inputs:
              codeCoverageTool: 'Cobertura'
              summaryFileLocation: 'actions/coverage/cobertura-coverage.xml'
              failIfCoverageEmpty: false
            condition: succeededOrFailed()

          - task: PublishTestResults@2
            displayName: 'Publish Test Results'
            inputs:
              testResultsFormat: 'JUnit'
              testResultsFiles: 'actions/test-results/*.xml'
              failTaskOnFailedTests: true
            condition: succeededOrFailed()

          - publish: actions/dist
            artifact: actions-dist-ci
            displayName: 'Publish Actions Artifact'

  # ========================================
  # Stage 2: Security & Quality Checks
  # ========================================
  - stage: SecurityScan
    displayName: 'Security & Quality'
    dependsOn: Build
    jobs:
      - job: SecurityChecks
        displayName: 'Security Scanning'
        steps:
          - script: |
              set -euo pipefail
              echo "Installing security tools..."
              pip install checkov tfsec --break-system-packages
            displayName: 'Install Security Tools'

          - script: |
              set -euo pipefail
              echo "Running Checkov security scan..."
              checkov -d environments/ \
                --framework terraform \
                --soft-fail \
                --output cli \
                --output junitxml \
                --output-file-path $(Build.ArtifactStagingDirectory)
            displayName: 'Checkov: Terraform Security Scan'
            continueOnError: true

          - script: |
              set -euo pipefail
              echo "Running tfsec analysis..."
              tfsec environments/ \
                --format junit \
                --out $(Build.ArtifactStagingDirectory)/tfsec-results.xml \
                --soft-fail
            displayName: 'TFSec: Static Analysis'
            continueOnError: true

          - task: PublishTestResults@2
            displayName: 'Publish Security Scan Results'
            inputs:
              testResultsFormat: 'JUnit'
              testResultsFiles: '$(Build.ArtifactStagingDirectory)/*.xml'
              testRunTitle: 'Security Scan Results'
            condition: succeededOrFailed()

      - job: LintCheck
        displayName: 'Linting & Formatting'
        steps:
          - task: TerraformInstaller@1
            displayName: 'Install Terraform $(TF_VERSION)'
            inputs:
              terraformVersion: $(TF_VERSION)

          - script: |
              set -euo pipefail
              echo "Checking Terraform formatting..."
              terraform fmt -check -recursive -diff
            displayName: 'Terraform Format Check'

          - script: |
              set -euo pipefail
              cd actions
              echo "Running ESLint..."
              npm run lint || true
            displayName: 'ESLint Check'
            continueOnError: true

  # ========================================
  # Stage 3: Terraform Validation
  # ========================================
  - stage: Validate
    displayName: 'Terraform Validation'
    dependsOn: SecurityScan
    jobs:
      - job: ValidateAll
        displayName: 'Validate All Environments'
        steps:
          - task: TerraformInstaller@1
            displayName: 'Install Terraform $(TF_VERSION)'
            inputs:
              terraformVersion: $(TF_VERSION)

          - script: |
              set -euo pipefail
              
              for env in dev qa val prod; do
                echo "========================================"
                echo "Validating: $env"
                echo "========================================"
                
                cd environments/$env
                
                echo "Initializing (no backend)..."
                terraform init -backend=false -input=false -no-color
                
                echo "Running validation..."
                terraform validate -no-color
                
                echo "✓ $env validation passed"
                cd ../..
                echo ""
              done
              
              echo "========================================"
              echo "All environments validated successfully"
              echo "========================================"
            displayName: 'Validate Terraform Configurations'

  # ========================================
  # Stage 4: Plan Preview (PR only)
  # ========================================
  - stage: PlanPreview
    displayName: 'Terraform Plan Preview'
    dependsOn: Validate
    condition: and(succeeded(), eq(variables['Build.Reason'], 'PullRequest'))
    jobs:
      - job: PreviewDev
        displayName: 'Preview DEV Changes'
        variables:
          - group: na-dev-axon-cic
        steps:
          - download: current
            artifact: actions-dist-ci

          - script: |
              set -euo pipefail
              mkdir -p actions/dist
              cp -r "$(Pipeline.Workspace)/actions-dist-ci/"* actions/dist/
            displayName: 'Restore Actions Build'

          - task: TerraformInstaller@1
            displayName: 'Install Terraform'
            inputs:
              terraformVersion: $(TF_VERSION)

          - script: |
              set -euo pipefail
              
              # Configure AWS CLI
              export AWS_ACCESS_KEY_ID="$(AWS_ACCESS_KEY_ID)"
              export AWS_SECRET_ACCESS_KEY="$(AWS_SECRET_ACCESS_KEY)"
              export AWS_DEFAULT_REGION="$(AWS_DEFAULT_REGION)"
              
              echo "Verifying AWS credentials..."
              aws sts get-caller-identity
              
              echo "Checking S3 bucket: $(TF_STATE_BUCKET)"
              aws s3api head-bucket --bucket "$(TF_STATE_BUCKET)" 2>/dev/null || {
                echo "WARNING: S3 bucket may not exist or is inaccessible"
              }
            displayName: 'Verify AWS Access'
            env:
              AWS_ACCESS_KEY_ID: $(AWS_ACCESS_KEY_ID)
              AWS_SECRET_ACCESS_KEY: $(AWS_SECRET_ACCESS_KEY)
              AWS_DEFAULT_REGION: $(AWS_DEFAULT_REGION)

          - script: |
              set -euo pipefail
              
              cd environments/dev
              
              # Configure AWS
              export AWS_ACCESS_KEY_ID="$(AWS_ACCESS_KEY_ID)"
              export AWS_SECRET_ACCESS_KEY="$(AWS_SECRET_ACCESS_KEY)"
              export AWS_DEFAULT_REGION="$(AWS_DEFAULT_REGION)"
              
              echo "Initializing Terraform..."
              terraform init \
                -backend-config="bucket=$(TF_STATE_BUCKET)" \
                -backend-config="key=terraform.tfstate" \
                -backend-config="region=$(AWS_DEFAULT_REGION)" \
                -backend-config="use_lockfile=true" \
                -backend-config="encrypt=true" \
                -input=false -no-color
              
              echo "Generating plan preview..."
              terraform plan \
                -input=false \
                -no-color \
                -lock=false \
                -var-file=dev.platform.tfvars.json \
                -var="app_callbacks=$(app_callbacks)" \
                -out=tfplan-preview
              
              echo "Converting plan to JSON..."
              terraform show -json tfplan-preview > "$(Build.ArtifactStagingDirectory)/dev-plan-preview.json"
              
              echo "Converting plan to readable format..."
              terraform show -no-color tfplan-preview > "$(Build.ArtifactStagingDirectory)/dev-plan-preview.txt"
            displayName: 'Generate DEV Plan Preview'
            env:
              TF_IN_AUTOMATION: '1'
              AUTH0_DOMAIN: $(AUTH0_DOMAIN)
              AUTH0_CLIENT_ID: $(AUTH0_CLIENT_ID)
              AUTH0_CLIENT_SECRET: $(AUTH0_CLIENT_SECRET)
              AWS_ACCESS_KEY_ID: $(AWS_ACCESS_KEY_ID)
              AWS_SECRET_ACCESS_KEY: $(AWS_SECRET_ACCESS_KEY)
              AWS_DEFAULT_REGION: $(AWS_DEFAULT_REGION)

          - publish: $(Build.ArtifactStagingDirectory)
            artifact: plan-preview-dev
            displayName: 'Publish Plan Preview'

          - script: |
              set -euo pipefail
              
              echo "========================================"
              echo "Plan Preview Summary"
              echo "========================================"
              echo "This is a preview only - no changes will be applied"
              echo "Review the plan artifact for detailed changes"
              echo "========================================"
            displayName: 'Plan Summary'

  # ========================================
  # Final Stage: CI Summary
  # ========================================
  - stage: Summary
    displayName: 'CI Summary'
    dependsOn:
      - Build
      - SecurityScan
      - Validate
    condition: succeededOrFailed()
    jobs:
      - job: CISummary
        displayName: 'Pipeline Summary'
        steps:
          - script: |
              set -euo pipefail
              
              echo "========================================"
              echo "CI Pipeline Summary"
              echo "========================================"
              echo "Build ID: $(Build.BuildId)"
              echo "Build Number: $(Build.BuildNumber)"
              echo "Source Branch: $(Build.SourceBranchName)"
              echo "Commit: $(Build.SourceVersion)"
              echo "Triggered by: $(Build.Reason)"
              echo "========================================"
              echo ""
              echo "✓ Actions built and tested"
              echo "✓ Security scans completed"
              echo "✓ Terraform validated"
              
              if [ "$(Build.Reason)" = "PullRequest" ]; then
                echo "✓ Plan preview generated"
                echo ""
                echo "Review the plan-preview-dev artifact before merging"
              fi
              
              echo ""
              echo "Pipeline completed successfully!"
              echo "========================================"
            displayName: 'Display Summary'