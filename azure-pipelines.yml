trigger:
  branches:
    include:
      - main
      - develop
  paths:
    include:
      - actions/**
      - modules/**
      - environments/**
      - azure-pipelines.yml

pr:
  branches:
    include:
      - main
  paths:
    include:
      - actions/**
      - modules/**
      - environments/**

pool:
  vmImage: 'ubuntu-latest'

variables:
  - group: auth0-terraform-common   # TF_STATE_BUCKET, TF_STATE_REGION (non-secrets)
  - name: TF_VERSION
    value: '1.13.3'                 # Terraform >= 1.11.0 required for S3-native locking
  - name: NODE_VERSION
    value: '20.x'

stages:
  # ========================================
  # Stage 1: Build and Test
  # ========================================
  - stage: Build
    displayName: 'Build & Test'
    jobs:
      - job: BuildActions
        displayName: 'Build TypeScript Actions'
        steps:
          - task: NodeTool@0
            displayName: 'Install Node.js'
            inputs:
              versionSpec: $(NODE_VERSION)

          - task: Cache@2
            displayName: 'Cache npm (actions)'
            inputs:
              key: 'npm | "$(Agent.OS)" | actions/package-lock.json'
              path: actions/node_modules
              restoreKeys: |
                npm | "$(Agent.OS)"

          - script: |
              set -euo pipefail
              cd actions
              npm ci
              npm run build
            displayName: 'Build Actions'

          - script: |
              set -euo pipefail
              cd actions
              npm test
            displayName: 'Run Tests'

          - script: |
              set -euo pipefail
              cd actions
              npm run test:coverage || true
            displayName: 'Generate Coverage (non-blocking)'

          - task: PublishCodeCoverageResults@1
            displayName: 'Publish Coverage'
            inputs:
              codeCoverageTool: 'Cobertura'
              summaryFileLocation: 'actions/coverage/cobertura-coverage.xml'
              failIfCoverageEmpty: false
            condition: succeededOrFailed()

          - publish: actions/dist
            artifact: actions-dist
            displayName: 'Publish Built Actions'

      - job: ValidateTerraform
        displayName: 'Validate Terraform'
        steps:
          - task: TerraformInstaller@1
            displayName: 'Install Terraform'
            inputs:
              terraformVersion: $(TF_VERSION)

          - script: |
              set -euo pipefail
              terraform fmt -check -recursive
            displayName: 'Check Terraform Format'

          - script: |
              set -euo pipefail
              for env in dev qa val prod; do
                echo "========================================="
                echo "Validating environment: $env"
                echo "========================================="
                cd environments/$env
                terraform init -backend=false -input=false -no-color
                terraform validate -no-color
                cd ../..
              done
            displayName: 'Validate All Environments'

  # ========================================
  # Stage 2: Deploy to DEV
  # ========================================
  - stage: DeployDev
    displayName: 'Deploy to DEV'
    dependsOn: Build
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
    jobs:
      - deployment: DeployDevEnvironment
        displayName: 'Deploy DEV'
        environment: 'auth0-dev'
        variables:
          - group: auth0-dev   # AUTH0_DOMAIN, AUTH0_CLIENT_ID (secret), AUTH0_CLIENT_SECRET (secret)
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self

                - download: current
                  artifact: actions-dist
                  displayName: 'Download Built Actions'

                - script: |
                    set -euo pipefail
                    mkdir -p actions/dist
                    cp -r "$(Pipeline.Workspace)/actions-dist/"* actions/dist/
                  displayName: 'Restore Actions Build'

                - task: TerraformInstaller@1
                  displayName: 'Install Terraform'
                  inputs:
                    terraformVersion: $(TF_VERSION)

                - task: AWSShellScript@1
                  displayName: 'Preflight: Verify S3 bucket settings'
                  inputs:
                    awsCredentials: 'aws-terraform-backend'
                    regionName: 'us-east-1'
                    scriptType: 'inline'
                    inlineScript: |
                      set -euo pipefail
                      BUCKET="$(TF_STATE_BUCKET)"
                      echo "Checking S3 bucket: $BUCKET"
                      v=$(aws s3api get-bucket-versioning --bucket "$BUCKET" --query 'Status' --output text || true)
                      if [ "$v" != "Enabled" ]; then
                        echo "ERROR: Bucket versioning must be Enabled for S3-native locking." >&2
                        exit 1
                      fi
                      sse=$(aws s3api get-bucket-encryption --bucket "$BUCKET" \
                        --query 'ServerSideEncryptionConfiguration.Rules[0].ApplyServerSideEncryptionByDefault.SSEAlgorithm' \
                        --output text || true)
                      if [ -z "$sse" ] || [ "$sse" = "None" ]; then
                        echo "ERROR: Bucket encryption must be enabled (AES256 or aws:kms)." >&2
                        exit 1
                      fi
                      echo "S3 preflight OK: versioning=$v, encryption=$sse"

                - task: AWSShellScript@1
                  displayName: 'Configure AWS Credentials'
                  inputs:
                    awsCredentials: 'aws-terraform-backend'
                    regionName: 'us-east-1'
                    scriptType: 'inline'
                    inlineScript: |
                      echo "AWS credentials configured"

                - script: |
                    set -euo pipefail
                    cd environments/dev
                    echo "========================================="
                    echo "Initializing Terraform with S3 backend"
                    echo "Environment: DEV"
                    echo "State: auth0/dev/terraform.tfstate"
                    echo "Locking: S3-native (use_lockfile=true)"
                    echo "========================================="
                    terraform init \
                      -backend-config="bucket=$(TF_STATE_BUCKET)" \
                      -backend-config="key=auth0/dev/terraform.tfstate" \
                      -backend-config="region=$(TF_STATE_REGION)" \
                      -backend-config="use_lockfile=true" \
                      -backend-config="encrypt=true" \
                      -input=false -no-color
                  displayName: 'Terraform Init (S3-Native Locking)'
                  env:
                    TF_IN_AUTOMATION: '1'
                    AUTH0_DOMAIN: $(AUTH0_DOMAIN)
                    AUTH0_CLIENT_ID: $(AUTH0_CLIENT_ID)
                    AUTH0_CLIENT_SECRET: $(AUTH0_CLIENT_SECRET)

                - script: |
                    set -euo pipefail
                    cd environments/dev
                    echo "========================================="
                    echo "Planning Terraform changes..."
                    echo "========================================="
                    terraform plan -input=false -no-color -lock-timeout=5m \
                      -var-file=dev.platform.tfvars.json \
                      -var="app_callbacks=$(app_callbacks)" \
                      -out=tfplan
                    terraform show -json tfplan > "$(Build.ArtifactStagingDirectory)/dev-plan.json"
                  displayName: 'Terraform Plan'
                  env:
                    TF_IN_AUTOMATION: '1'
                    AUTH0_DOMAIN: $(AUTH0_DOMAIN)
                    AUTH0_CLIENT_ID: $(AUTH0_CLIENT_ID)
                    AUTH0_CLIENT_SECRET: $(AUTH0_CLIENT_SECRET)

                - publish: $(Build.ArtifactStagingDirectory)/dev-plan.json
                  artifact: dev-plan
                  displayName: 'Publish DEV Plan'
                  condition: succeededOrFailed()

                - script: |
                    set -euo pipefail
                    cd environments/dev
                    echo "========================================="
                    echo "Applying Terraform changes..."
                    echo "========================================="
                    terraform apply -input=false -no-color -lock-timeout=5m -auto-approve tfplan
                    echo ""
                    echo "Deployment complete."
                  displayName: 'Terraform Apply'
                  env:
                    TF_IN_AUTOMATION: '1'
                    AUTH0_DOMAIN: $(AUTH0_DOMAIN)
                    AUTH0_CLIENT_ID: $(AUTH0_CLIENT_ID)
                    AUTH0_CLIENT_SECRET: $(AUTH0_CLIENT_SECRET)

                - script: |
                    set -euo pipefail
                    cd environments/dev
                    terraform output -json > "$(Build.ArtifactStagingDirectory)/dev-outputs.json"
                  displayName: 'Capture Terraform Outputs'
                  continueOnError: true

                - publish: $(Build.ArtifactStagingDirectory)/dev-outputs.json
                  artifact: dev-outputs
                  displayName: 'Publish DEV Outputs'
                  condition: succeededOrFailed()

  # ========================================
  # Stage 3: Deploy to QA
  # ========================================
  - stage: DeployQA
    displayName: 'Deploy to QA'
    dependsOn: DeployDev
    condition: succeeded()
    jobs:
      - deployment: DeployQAEnvironment
        displayName: 'Deploy QA'
        environment: 'auth0-qa'
        variables:
          - group: auth0-qa
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self
                - download: current
                  artifact: actions-dist
                - script: |
                    set -euo pipefail
                    mkdir -p actions/dist
                    cp -r "$(Pipeline.Workspace)/actions-dist/"* actions/dist/
                  displayName: 'Restore Actions Build'
                - task: TerraformInstaller@1
                  displayName: 'Install Terraform'
                  inputs:
                    terraformVersion: $(TF_VERSION)
                - task: AWSShellScript@1
                  displayName: 'Configure AWS Credentials'
                  inputs:
                    awsCredentials: 'aws-terraform-backend'
                    regionName: 'us-east-1'
                    scriptType: 'inline'
                    inlineScript: |
                      echo "AWS credentials configured"
                - script: |
                    set -euo pipefail
                    cd environments/qa
                    echo "Deploying to QA environment..."
                    terraform init \
                      -backend-config="bucket=$(TF_STATE_BUCKET)" \
                      -backend-config="key=auth0/qa/terraform.tfstate" \
                      -backend-config="region=$(TF_STATE_REGION)" \
                      -backend-config="use_lockfile=true" \
                      -backend-config="encrypt=true" \
                      -input=false -no-color
                    terraform plan -input=false -no-color -lock-timeout=5m \
                      -var-file=qa.platform.tfvars.json \
                      -var="app_callbacks=$(app_callbacks)" \
                      -out=tfplan
                    terraform show -json tfplan > "$(Build.ArtifactStagingDirectory)/qa-plan.json"
                    terraform apply -input=false -no-color -lock-timeout=5m -auto-approve tfplan
                    echo "QA deployment complete."
                  displayName: 'Terraform Deploy to QA'
                  env:
                    TF_IN_AUTOMATION: '1'
                    AUTH0_DOMAIN: $(AUTH0_DOMAIN)
                    AUTH0_CLIENT_ID: $(AUTH0_CLIENT_ID)
                    AUTH0_CLIENT_SECRET: $(AUTH0_CLIENT_SECRET)
                - publish: $(Build.ArtifactStagingDirectory)/qa-plan.json
                  artifact: qa-plan
                  displayName: 'Publish QA Plan'
                  condition: succeededOrFailed()
                - script: |
                    set -euo pipefail
                    cd environments/qa
                    terraform output -json > "$(Build.ArtifactStagingDirectory)/qa-outputs.json"
                  displayName: 'Capture Terraform Outputs'
                  continueOnError: true
                - publish: $(Build.ArtifactStagingDirectory)/qa-outputs.json
                  artifact: qa-outputs
                  displayName: 'Publish QA Outputs'
                  condition: succeededOrFailed()

  # ========================================
  # Stage 4: Deploy to VAL
  # ========================================
  - stage: DeployVal
    displayName: 'Deploy to VAL'
    dependsOn: DeployQA
    condition: succeeded()
    jobs:
      - deployment: DeployValEnvironment
        displayName: 'Deploy VAL'
        environment: 'auth0-val'
        variables:
          - group: auth0-val
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self
                - download: current
                  artifact: actions-dist
                - script: |
                    set -euo pipefail
                    mkdir -p actions/dist
                    cp -r "$(Pipeline.Workspace)/actions-dist/"* actions/dist/
                  displayName: 'Restore Actions Build'
                - task: TerraformInstaller@1
                  displayName: 'Install Terraform'
                  inputs:
                    terraformVersion: $(TF_VERSION)
                - task: AWSShellScript@1
                  displayName: 'Configure AWS Credentials'
                  inputs:
                    awsCredentials: 'aws-terraform-backend'
                    regionName: 'us-east-1'
                    scriptType: 'inline'
                    inlineScript: |
                      echo "AWS credentials configured"
                - script: |
                    set -euo pipefail
                    cd environments/val
                    echo "Deploying to VAL environment..."
                    terraform init \
                      -backend-config="bucket=$(TF_STATE_BUCKET)" \
                      -backend-config="key=auth0/val/terraform.tfstate" \
                      -backend-config="region=$(TF_STATE_REGION)" \
                      -backend-config="use_lockfile=true" \
                      -backend-config="encrypt=true" \
                      -input=false -no-color
                    terraform plan -input=false -no-color -lock-timeout=5m \
                      -var-file=val.platform.tfvars.json \
                      -var="app_callbacks=$(app_callbacks)" \
                      -out=tfplan
                    terraform show -json tfplan > "$(Build.ArtifactStagingDirectory)/val-plan.json"
                    terraform apply -input=false -no-color -lock-timeout=5m -auto-approve tfplan
                    echo "VAL deployment complete."
                  displayName: 'Terraform Deploy to VAL'
                  env:
                    TF_IN_AUTOMATION: '1'
                    AUTH0_DOMAIN: $(AUTH0_DOMAIN)
                    AUTH0_CLIENT_ID: $(AUTH0_CLIENT_ID)
                    AUTH0_CLIENT_SECRET: $(AUTH0_CLIENT_SECRET)
                - publish: $(Build.ArtifactStagingDirectory)/val-plan.json
                  artifact: val-plan
                  displayName: 'Publish VAL Plan'
                  condition: succeededOrFailed()
                - script: |
                    set -euo pipefail
                    cd environments/val
                    terraform output -json > "$(Build.ArtifactStagingDirectory)/val-outputs.json"
                  displayName: 'Capture Terraform Outputs'
                  continueOnError: true
                - publish: $(Build.ArtifactStagingDirectory)/val-outputs.json
                  artifact: val-outputs
                  displayName: 'Publish VAL Outputs'
                  condition: succeededOrFailed()

  # ========================================
  # Stage 5: Deploy to PROD (Manual Approval)
  # ========================================
  - stage: DeployProd
    displayName: 'Deploy to PROD'
    dependsOn: DeployVal
    condition: succeeded()
    jobs:
      - deployment: DeployProdEnvironment
        displayName: 'Deploy PROD'
        environment: 'auth0-prod'  # Configure approval gates in Azure DevOps Environments
        variables:
          - group: auth0-prod
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self
                - download: current
                  artifact: actions-dist
                - script: |
                    set -euo pipefail
                    mkdir -p actions/dist
                    cp -r "$(Pipeline.Workspace)/actions-dist/"* actions/dist/
                  displayName: 'Restore Actions Build'
                - task: TerraformInstaller@1
                  displayName: 'Install Terraform'
                  inputs:
                    terraformVersion: $(TF_VERSION)
                - task: AWSShellScript@1
                  displayName: 'Configure AWS Credentials'
                  inputs:
                    awsCredentials: 'aws-terraform-backend'
                    regionName: 'us-east-1'
                    scriptType: 'inline'
                    inlineScript: |
                      echo "AWS credentials configured"
                - script: |
                    set -euo pipefail
                    cd environments/prod
                    echo "========================================="
                    echo "PRODUCTION DEPLOYMENT"
                    echo "========================================="
                    terraform init \
                      -backend-config="bucket=$(TF_STATE_BUCKET)" \
                      -backend-config="key=auth0/prod/terraform.tfstate" \
                      -backend-config="region=$(TF_STATE_REGION)" \
                      -backend-config="use_lockfile=true" \
                      -backend-config="encrypt=true" \
                      -input=false -no-color
                  displayName: 'Terraform Init'
                  env:
                    TF_IN_AUTOMATION: '1'
                    AUTH0_DOMAIN: $(AUTH0_DOMAIN)
                    AUTH0_CLIENT_ID: $(AUTH0_CLIENT_ID)
                    AUTH0_CLIENT_SECRET: $(AUTH0_CLIENT_SECRET)
                - script: |
                    set -euo pipefail
                    cd environments/prod
                    echo "Planning PRODUCTION changes..."
                    terraform plan -input=false -no-color -lock-timeout=5m \
                      -var-file=prod.platform.tfvars.json \
                      -var="app_callbacks=$(app_callbacks)" \
                      -out=tfplan
                    terraform show -json tfplan > "$(Build.ArtifactStagingDirectory)/prod-plan.json"
                  displayName: 'Terraform Plan'
                  env:
                    TF_IN_AUTOMATION: '1'
                    AUTH0_DOMAIN: $(AUTH0_DOMAIN)
                    AUTH0_CLIENT_ID: $(AUTH0_CLIENT_ID)
                    AUTH0_CLIENT_SECRET: $(AUTH0_CLIENT_SECRET)
                - publish: $(Build.ArtifactStagingDirectory)/prod-plan.json
                  artifact: prod-plan
                  displayName: 'Publish PROD Plan'
                  condition: succeededOrFailed()
                - script: |
                    set -euo pipefail
                    cd environments/prod
                    echo "Applying PRODUCTION changes..."
                    terraform apply -input=false -no-color -lock-timeout=5m -auto-approve tfplan
                    echo ""
                    echo "========================================="
                    echo "PRODUCTION DEPLOYMENT COMPLETE!"
                    echo "========================================="
                  displayName: 'Terraform Apply'
                  env:
                    TF_IN_AUTOMATION: '1'
                    AUTH0_DOMAIN: $(AUTH0_DOMAIN)
                    AUTH0_CLIENT_ID: $(AUTH0_CLIENT_ID)
                    AUTH0_CLIENT_SECRET: $(AUTH0_CLIENT_SECRET)
                - script: |
                    set -euo pipefail
                    cd environments/prod
                    terraform output -json > "$(Build.ArtifactStagingDirectory)/prod-outputs.json"
                  displayName: 'Capture Terraform Outputs'
                  continueOnError: true
                - publish: $(Build.ArtifactStagingDirectory)/prod-outputs.json
                  artifact: prod-outputs
                  displayName: 'Publish PROD Outputs'
                  condition: succeededOrFailed()
                - script: |
                    set -euo pipefail
                    echo "========================================="
                    echo "Post-Deployment Summary"
                    echo "========================================="
                    echo "Environment: PRODUCTION"
                    echo "Terraform Version: $(TF_VERSION)"
                    echo "Backend: S3 with native locking"
                    echo "Timestamp: $(date -u)"
                    echo "========================================="
                  displayName: 'Deployment Summary'
