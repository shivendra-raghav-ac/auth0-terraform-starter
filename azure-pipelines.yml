name: $(Date:yyyyMMdd)$(Rev:.r)

trigger:
  branches:
    include:
      - master
      - develop
      - feature/*
  paths:
    include:
      - actions/**
      - modules/**
      - environments/**
      - azure-pipelines.yml

pr:
  branches:
    include:
      - master
      - develop
  paths:
    include:
      - actions/**
      - modules/**
      - environments/**

pool:
  vmImage: 'ubuntu-latest'

variables:
  - group: terraform-common-axon-cic
  - name: NODE_VERSION
    value: '20.x'
  - name: TF_VERSION
    value: '1.13.3'

stages:
  # ========================================
  # CI STAGES (Always Run)
  # ========================================

  # Stage 1: Build TypeScript Actions
  # ========================================
  - stage: Build
    displayName: 'Build Actions'
    jobs:
      - job: BuildActions
        displayName: 'Build TypeScript Actions'
        steps:
          - task: NodeTool@0
            displayName: 'Install Node.js $(NODE_VERSION)'
            inputs:
              versionSpec: $(NODE_VERSION)

          - task: Cache@2
            displayName: 'Cache npm dependencies'
            condition: and(succeeded(), exists('actions/package-lock.json'))
            inputs:
              key: 'npm | "$(Agent.OS)" | actions/package-lock.json'
              path: actions/node_modules
              restoreKeys: |
                npm | "$(Agent.OS)"

          - script: |
              set -euo pipefail
              cd actions
              echo "Installing dependencies..."
              npm ci
              echo "Building actions..."
              npm run build
            displayName: 'Build Actions'

          - script: |
              set -euo pipefail
              cd actions
              echo "Running unit tests..."
              npm test
            displayName: 'Run Unit Tests'

          - script: |
              set -euo pipefail
              cd actions
              echo "Generating test coverage..."
              npm run test:coverage || true
            displayName: 'Generate Coverage Report'
            continueOnError: true

          - task: PublishCodeCoverageResults@1
            displayName: 'Publish Coverage Results'
            inputs:
              codeCoverageTool: 'Cobertura'
              summaryFileLocation: 'actions/coverage/cobertura-coverage.xml'
              failIfCoverageEmpty: false
            condition: succeededOrFailed()

          - task: PublishTestResults@2
            displayName: 'Publish Test Results'
            inputs:
              testResultsFormat: 'JUnit'
              testResultsFiles: 'actions/test-results/*.xml'
              failTaskOnFailedTests: true
            condition: succeededOrFailed()

          - publish: actions/dist
            artifact: actions-dist
            displayName: 'Publish Actions Artifact'

  # ========================================
  # Stage 2: Security & Quality Checks
  # ========================================
  - stage: SecurityScan
    displayName: 'Security & Quality'
    dependsOn: Build
    jobs:
      - job: SecurityChecks
        displayName: 'Security Scanning'
        steps:
          - script: |
              set -euo pipefail
              echo "========================================"
              echo "Installing Checkov (Terraform Security Scanner)"
              echo "========================================"
              pip install checkov --break-system-packages
              
              echo ""
              echo "Checkov version:"
              checkov --version
              echo "========================================"
            displayName: 'Install Checkov'

          - script: |
              set -euo pipefail
              echo "========================================"
              echo "Running Checkov Security Scan"
              echo "========================================"
              echo "Scanning: environments/"
              echo ""
              
              checkov -d environments/ \
                --framework terraform \
                --soft-fail \
                --output cli \
                --output junitxml \
                --output-file-path $(Build.ArtifactStagingDirectory)
              
              echo ""
              echo "Scan complete. Results saved to artifacts."
              echo "========================================"
            displayName: 'Checkov: Terraform Security Scan'
            continueOnError: true

          - task: PublishTestResults@2
            displayName: 'Publish Security Scan Results'
            inputs:
              testResultsFormat: 'JUnit'
              testResultsFiles: '$(Build.ArtifactStagingDirectory)/results_junitxml.xml'
              testRunTitle: 'Checkov Security Scan'
              failTaskOnFailedTests: false
            condition: succeededOrFailed()

          - publish: $(Build.ArtifactStagingDirectory)
            artifact: security-scan-results
            displayName: 'Publish Scan Artifacts'
            condition: succeededOrFailed()

      - job: LintCheck
        displayName: 'Linting & Formatting'
        steps:
          - task: TerraformInstaller@1
            displayName: 'Install Terraform $(TF_VERSION)'
            inputs:
              terraformVersion: $(TF_VERSION)

          - script: |
              set -euo pipefail
              echo "========================================"
              echo "Checking Terraform Formatting"
              echo "========================================"
              terraform fmt -check -recursive -diff
              echo ""
              echo "✓ Terraform formatting is correct"
            displayName: 'Terraform Format Check'

          - script: |
              set -euo pipefail
              cd actions
              echo "Running ESLint..."
              npm run lint || echo "⚠ ESLint warnings found (non-blocking)"
            displayName: 'ESLint Check'
            continueOnError: true

  # ========================================
  # Stage 3: Terraform Validation
  # ========================================
  - stage: Validate
    displayName: 'Terraform Validation'
    dependsOn: SecurityScan
    jobs:
      - job: ValidateAll
        displayName: 'Validate All Environments'
        steps:
          - task: TerraformInstaller@1
            displayName: 'Install Terraform $(TF_VERSION)'
            inputs:
              terraformVersion: $(TF_VERSION)

          - script: |
              set -euo pipefail
              
              echo "========================================"
              echo "Terraform Validation - All Environments"
              echo "========================================"
              echo ""
              
              for env in dev qa val prod; do
                echo "----------------------------------------"
                echo "Validating: $env"
                echo "----------------------------------------"
                
                cd environments/$env
                
                echo "Initializing (no backend)..."
                terraform init -backend=false -input=false -no-color
                
                echo "Running validation..."
                terraform validate -no-color
                
                echo "✓ $env validation passed"
                cd ../..
                echo ""
              done
              
              echo "========================================"
              echo "✓ All environments validated successfully"
              echo "========================================"
            displayName: 'Validate Terraform Configurations'

  # ========================================
  # Stage 4: Plan Preview (PR only)
  # ========================================
  - stage: PlanPreview
    displayName: 'Plan Preview (PR)'
    dependsOn: Validate
    condition: and(succeeded(), eq(variables['Build.Reason'], 'PullRequest'))
    jobs:
      - job: PreviewDev
        displayName: 'Preview DEV Changes'
        variables:
          - group: na-dev-axon-cic
        steps:
          - download: current
            artifact: actions-dist

          - script: |
              set -euo pipefail
              mkdir -p actions/dist
              cp -r "$(Pipeline.Workspace)/actions-dist/"* actions/dist/
            displayName: 'Restore Actions Build'

          - task: TerraformInstaller@1
            displayName: 'Install Terraform'
            inputs:
              terraformVersion: $(TF_VERSION)

          - script: |
              set -euo pipefail
              
              export AWS_ACCESS_KEY_ID="$(AWS_ACCESS_KEY_ID)"
              export AWS_SECRET_ACCESS_KEY="$(AWS_SECRET_ACCESS_KEY)"
              export AWS_DEFAULT_REGION="$(AWS_DEFAULT_REGION)"
              
              echo "Verifying AWS credentials..."
              aws sts get-caller-identity
              
              echo "Checking S3 bucket: $(TF_STATE_BUCKET)"
              aws s3api head-bucket --bucket "$(TF_STATE_BUCKET)" 2>/dev/null || {
                echo "⚠ WARNING: S3 bucket may not exist or is inaccessible"
              }
            displayName: 'Verify AWS Access'
            env:
              AWS_ACCESS_KEY_ID: $(AWS_ACCESS_KEY_ID)
              AWS_SECRET_ACCESS_KEY: $(AWS_SECRET_ACCESS_KEY)
              AWS_DEFAULT_REGION: $(AWS_DEFAULT_REGION)

          - script: |
              set -euo pipefail
              
              cd environments/dev
              
              export AWS_ACCESS_KEY_ID="$(AWS_ACCESS_KEY_ID)"
              export AWS_SECRET_ACCESS_KEY="$(AWS_SECRET_ACCESS_KEY)"
              export AWS_DEFAULT_REGION="$(AWS_DEFAULT_REGION)"
              
              echo "========================================"
              echo "Plan Preview - DEV"
              echo "========================================"
              
              terraform init \
                -backend-config="bucket=$(TF_STATE_BUCKET)" \
                -backend-config="key=terraform.tfstate" \
                -backend-config="region=$(AWS_DEFAULT_REGION)" \
                -backend-config="use_lockfile=true" \
                -backend-config="encrypt=true" \
                -input=false -no-color
              
              echo ""
              echo "Generating plan preview (read-only)..."
              terraform plan \
                -input=false \
                -no-color \
                -lock=false \
                -var-file=dev.platform.tfvars.json \
                -var="app_callbacks=$(app_callbacks)" \
                -out=tfplan-preview
              
              echo ""
              echo "Exporting plan..."
              terraform show -json tfplan-preview > "$(Build.ArtifactStagingDirectory)/dev-plan-preview.json"
              terraform show -no-color tfplan-preview > "$(Build.ArtifactStagingDirectory)/dev-plan-preview.txt"
              
              echo ""
              echo "✓ Plan preview generated"
              echo "========================================"
            displayName: 'Generate DEV Plan Preview'
            env:
              TF_IN_AUTOMATION: '1'
              AUTH0_DOMAIN: $(AUTH0_DOMAIN)
              AUTH0_CLIENT_ID: $(AUTH0_CLIENT_ID)
              AUTH0_CLIENT_SECRET: $(AUTH0_CLIENT_SECRET)
              AWS_ACCESS_KEY_ID: $(AWS_ACCESS_KEY_ID)
              AWS_SECRET_ACCESS_KEY: $(AWS_SECRET_ACCESS_KEY)
              AWS_DEFAULT_REGION: $(AWS_DEFAULT_REGION)

          - publish: $(Build.ArtifactStagingDirectory)
            artifact: plan-preview-dev
            displayName: 'Publish Plan Preview'

          - script: |
              echo "========================================"
              echo "Plan Preview Summary"
              echo "========================================"
              echo "This is a preview only - no changes applied"
              echo "Download the plan-preview-dev artifact to review"
              echo "========================================"
            displayName: 'Plan Summary'

  # ========================================
  # Stage 5: CI Summary
  # ========================================
  - stage: CISummary
    displayName: 'CI Summary'
    dependsOn:
      - Build
      - SecurityScan
      - Validate
    condition: succeededOrFailed()
    jobs:
      - job: Summary
        displayName: 'Pipeline Summary'
        steps:
          - script: |
              set -euo pipefail
              
              echo "========================================"
              echo "CI Pipeline Summary"
              echo "========================================"
              echo "Build ID: $(Build.BuildId)"
              echo "Build Number: $(Build.BuildNumber)"
              echo "Source Branch: $(Build.SourceBranchName)"
              echo "Commit: $(Build.SourceVersion)"
              echo "Triggered by: $(Build.Reason)"
              echo "========================================"
              echo ""
              echo "✓ Actions built and tested"
              echo "✓ Security scans completed"
              echo "✓ Terraform validated"
              
              if [ "$(Build.Reason)" = "PullRequest" ]; then
                echo "✓ Plan preview generated"
                echo ""
                echo "→ Review artifacts before merging"
              fi
              
              if [ "$(Build.SourceBranchName)" = "master" ] && [ "$(Build.Reason)" != "PullRequest" ]; then
                echo ""
                echo "→ Deployment stages will follow"
              fi
              
              echo ""
              echo "Pipeline completed successfully!"
              echo "========================================"
            displayName: 'Display Summary'

  # ========================================
  # CD STAGES (Only on master branch, after CI passes)
  # ========================================

  # Stage 6: Deploy to DEV
  # ========================================
  - stage: DeployDev
    displayName: 'Deploy to DEV'
    dependsOn:
      - Build
      - SecurityScan
      - Validate
      - CISummary
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/master'))
    jobs:
      - deployment: DeployDevEnvironment
        displayName: 'Deploy DEV'
        environment: 'na-dev-axon-cic'
        variables:
          - group: na-dev-axon-cic
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self

                - download: current
                  artifact: actions-dist
                  displayName: 'Download CI Build Artifacts'

                - script: |
                    set -euo pipefail
                    mkdir -p actions/dist
                    cp -r "$(Pipeline.Workspace)/actions-dist/"* actions/dist/
                    echo "✓ Actions restored from CI build"
                  displayName: 'Restore Actions Build'

                - task: TerraformInstaller@1
                  displayName: 'Install Terraform $(TF_VERSION)'
                  inputs:
                    terraformVersion: $(TF_VERSION)

                - script: |
                    set -euo pipefail
                    
                    export AWS_ACCESS_KEY_ID="$(AWS_ACCESS_KEY_ID)"
                    export AWS_SECRET_ACCESS_KEY="$(AWS_SECRET_ACCESS_KEY)"
                    export AWS_DEFAULT_REGION="$(AWS_DEFAULT_REGION)"
                    
                    echo "========================================"
                    echo "AWS Preflight Checks - DEV"
                    echo "========================================"
                    
                    echo "Verifying AWS credentials..."
                    CALLER_IDENTITY=$(aws sts get-caller-identity)
                    echo "Authenticated as: $(echo $CALLER_IDENTITY | jq -r .Arn)"
                    
                    BUCKET="$(TF_STATE_BUCKET)"
                    echo ""
                    echo "Checking S3 bucket: $BUCKET"
                    
                    VERSION_STATUS=$(aws s3api get-bucket-versioning \
                      --bucket "$BUCKET" \
                      --query 'Status' \
                      --output text 2>/dev/null || echo "None")
                    
                    if [ "$VERSION_STATUS" != "Enabled" ]; then
                      echo "❌ ERROR: Bucket versioning is not enabled"
                      echo "Enable with: aws s3api put-bucket-versioning --bucket $BUCKET --versioning-configuration Status=Enabled"
                      exit 1
                    fi
                    echo "✓ Versioning: $VERSION_STATUS"
                    
                    SSE_ALGO=$(aws s3api get-bucket-encryption \
                      --bucket "$BUCKET" \
                      --query 'ServerSideEncryptionConfiguration.Rules[0].ApplyServerSideEncryptionByDefault.SSEAlgorithm' \
                      --output text 2>/dev/null || echo "None")
                    
                    if [ "$SSE_ALGO" = "None" ] || [ -z "$SSE_ALGO" ]; then
                      echo "❌ ERROR: Bucket encryption is not enabled"
                      exit 1
                    fi
                    echo "✓ Encryption: $SSE_ALGO"
                    
                    echo ""
                    echo "✓ All preflight checks passed"
                    echo "========================================"
                  displayName: 'Preflight: Verify AWS & S3'
                  env:
                    AWS_ACCESS_KEY_ID: $(AWS_ACCESS_KEY_ID)
                    AWS_SECRET_ACCESS_KEY: $(AWS_SECRET_ACCESS_KEY)
                    AWS_DEFAULT_REGION: $(AWS_DEFAULT_REGION)

                - script: |
                    set -euo pipefail
                    
                    cd environments/dev
                    
                    export AWS_ACCESS_KEY_ID="$(AWS_ACCESS_KEY_ID)"
                    export AWS_SECRET_ACCESS_KEY="$(AWS_SECRET_ACCESS_KEY)"
                    export AWS_DEFAULT_REGION="$(AWS_DEFAULT_REGION)"
                    
                    echo "========================================"
                    echo "Terraform Init - DEV"
                    echo "========================================"
                    echo "Environment: $(ENVIRONMENT_NAME)"
                    echo "State Bucket: $(TF_STATE_BUCKET)"
                    echo "State Key: terraform.tfstate"
                    echo "Locking: S3-native (use_lockfile=true)"
                    echo "========================================"
                    
                    terraform init \
                      -backend-config="bucket=$(TF_STATE_BUCKET)" \
                      -backend-config="key=terraform.tfstate" \
                      -backend-config="region=$(AWS_DEFAULT_REGION)" \
                      -backend-config="use_lockfile=true" \
                      -backend-config="encrypt=true" \
                      -input=false -no-color
                    
                    echo "✓ Terraform initialized"
                  displayName: 'Terraform Init'
                  env:
                    TF_IN_AUTOMATION: '1'
                    AUTH0_DOMAIN: $(AUTH0_DOMAIN)
                    AUTH0_CLIENT_ID: $(AUTH0_CLIENT_ID)
                    AUTH0_CLIENT_SECRET: $(AUTH0_CLIENT_SECRET)
                    AWS_ACCESS_KEY_ID: $(AWS_ACCESS_KEY_ID)
                    AWS_SECRET_ACCESS_KEY: $(AWS_SECRET_ACCESS_KEY)
                    AWS_DEFAULT_REGION: $(AWS_DEFAULT_REGION)

                - script: |
                    set -euo pipefail
                    
                    cd environments/dev
                    
                    export AWS_ACCESS_KEY_ID="$(AWS_ACCESS_KEY_ID)"
                    export AWS_SECRET_ACCESS_KEY="$(AWS_SECRET_ACCESS_KEY)"
                    export AWS_DEFAULT_REGION="$(AWS_DEFAULT_REGION)"
                    
                    echo "========================================"
                    echo "Terraform Plan - DEV"
                    echo "========================================"
                    
                    terraform plan \
                      -input=false \
                      -no-color \
                      -lock-timeout=5m \
                      -var-file=dev.platform.tfvars.json \
                      -var="app_callbacks=$(app_callbacks)" \
                      -out=tfplan
                    
                    echo ""
                    echo "Exporting plan..."
                    terraform show -json tfplan > "$(Build.ArtifactStagingDirectory)/dev-plan.json"
                    terraform show -no-color tfplan > "$(Build.ArtifactStagingDirectory)/dev-plan.txt"
                    
                    echo "✓ Plan generated"
                  displayName: 'Terraform Plan'
                  env:
                    TF_IN_AUTOMATION: '1'
                    AUTH0_DOMAIN: $(AUTH0_DOMAIN)
                    AUTH0_CLIENT_ID: $(AUTH0_CLIENT_ID)
                    AUTH0_CLIENT_SECRET: $(AUTH0_CLIENT_SECRET)
                    AWS_ACCESS_KEY_ID: $(AWS_ACCESS_KEY_ID)
                    AWS_SECRET_ACCESS_KEY: $(AWS_SECRET_ACCESS_KEY)
                    AWS_DEFAULT_REGION: $(AWS_DEFAULT_REGION)

                - publish: $(Build.ArtifactStagingDirectory)
                  artifact: dev-plan
                  displayName: 'Publish DEV Plan'

                - script: |
                    set -euo pipefail
                    
                    cd environments/dev
                    
                    export AWS_ACCESS_KEY_ID="$(AWS_ACCESS_KEY_ID)"
                    export AWS_SECRET_ACCESS_KEY="$(AWS_SECRET_ACCESS_KEY)"
                    export AWS_DEFAULT_REGION="$(AWS_DEFAULT_REGION)"
                    
                    echo "========================================"
                    echo "Terraform Apply - DEV"
                    echo "========================================"
                    
                    terraform apply \
                      -input=false \
                      -no-color \
                      -lock-timeout=5m \
                      -auto-approve \
                      tfplan
                    
                    echo ""
                    echo "✓ DEV deployment complete"
                    echo "========================================"
                  displayName: 'Terraform Apply'
                  env:
                    TF_IN_AUTOMATION: '1'
                    AUTH0_DOMAIN: $(AUTH0_DOMAIN)
                    AUTH0_CLIENT_ID: $(AUTH0_CLIENT_ID)
                    AUTH0_CLIENT_SECRET: $(AUTH0_CLIENT_SECRET)
                    AWS_ACCESS_KEY_ID: $(AWS_ACCESS_KEY_ID)
                    AWS_SECRET_ACCESS_KEY: $(AWS_SECRET_ACCESS_KEY)
                    AWS_DEFAULT_REGION: $(AWS_DEFAULT_REGION)

                - script: |
                    set -euo pipefail
                    
                    cd environments/dev
                    
                    export AWS_ACCESS_KEY_ID="$(AWS_ACCESS_KEY_ID)"
                    export AWS_SECRET_ACCESS_KEY="$(AWS_SECRET_ACCESS_KEY)"
                    export AWS_DEFAULT_REGION="$(AWS_DEFAULT_REGION)"
                    
                    terraform output -json > "$(Build.ArtifactStagingDirectory)/dev-outputs.json"
                    terraform output -no-color > "$(Build.ArtifactStagingDirectory)/dev-outputs.txt"
                  displayName: 'Capture Terraform Outputs'
                  continueOnError: true
                  env:
                    AWS_ACCESS_KEY_ID: $(AWS_ACCESS_KEY_ID)
                    AWS_SECRET_ACCESS_KEY: $(AWS_SECRET_ACCESS_KEY)
                    AWS_DEFAULT_REGION: $(AWS_DEFAULT_REGION)

                - publish: $(Build.ArtifactStagingDirectory)
                  artifact: dev-outputs
                  displayName: 'Publish DEV Outputs'

  # ========================================
  # Stage 7: Deploy to QA
  # ========================================
  - stage: DeployQA
    displayName: 'Deploy to QA'
    dependsOn: DeployDev
    condition: succeeded()
    jobs:
      - deployment: DeployQAEnvironment
        displayName: 'Deploy QA'
        environment: 'na-qa-axon-cic'
        variables:
          - group: na-qa-axon-cic
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self
                
                - download: current
                  artifact: actions-dist
                  displayName: 'Download CI Build Artifacts'

                - script: |
                    set -euo pipefail
                    mkdir -p actions/dist
                    cp -r "$(Pipeline.Workspace)/actions-dist/"* actions/dist/
                  displayName: 'Restore Actions Build'

                - task: TerraformInstaller@1
                  displayName: 'Install Terraform'
                  inputs:
                    terraformVersion: $(TF_VERSION)

                - script: |
                    set -euo pipefail
                    cd environments/qa
                    
                    export AWS_ACCESS_KEY_ID="$(AWS_ACCESS_KEY_ID)"
                    export AWS_SECRET_ACCESS_KEY="$(AWS_SECRET_ACCESS_KEY)"
                    export AWS_DEFAULT_REGION="$(AWS_DEFAULT_REGION)"
                    
                    echo "========================================"
                    echo "Deploying to QA: $(ENVIRONMENT_NAME)"
                    echo "========================================"
                    
                    terraform init \
                      -backend-config="bucket=$(TF_STATE_BUCKET)" \
                      -backend-config="key=terraform.tfstate" \
                      -backend-config="region=$(AWS_DEFAULT_REGION)" \
                      -backend-config="use_lockfile=true" \
                      -backend-config="encrypt=true" \
                      -input=false -no-color
                    
                    terraform plan \
                      -input=false -no-color -lock-timeout=5m \
                      -var-file=qa.platform.tfvars.json \
                      -var="app_callbacks=$(app_callbacks)" \
                      -out=tfplan
                    
                    terraform show -json tfplan > "$(Build.ArtifactStagingDirectory)/qa-plan.json"
                    terraform show -no-color tfplan > "$(Build.ArtifactStagingDirectory)/qa-plan.txt"
                    
                    terraform apply -input=false -no-color -lock-timeout=5m -auto-approve tfplan
                    
                    terraform output -json > "$(Build.ArtifactStagingDirectory)/qa-outputs.json"
                    
                    echo "✓ QA deployment complete"
                    echo "========================================"
                  displayName: 'Deploy to QA'
                  env:
                    TF_IN_AUTOMATION: '1'
                    AUTH0_DOMAIN: $(AUTH0_DOMAIN)
                    AUTH0_CLIENT_ID: $(AUTH0_CLIENT_ID)
                    AUTH0_CLIENT_SECRET: $(AUTH0_CLIENT_SECRET)
                    AWS_ACCESS_KEY_ID: $(AWS_ACCESS_KEY_ID)
                    AWS_SECRET_ACCESS_KEY: $(AWS_SECRET_ACCESS_KEY)
                    AWS_DEFAULT_REGION: $(AWS_DEFAULT_REGION)

                - publish: $(Build.ArtifactStagingDirectory)
                  artifact: qa-artifacts
                  displayName: 'Publish QA Artifacts'

  # ========================================
  # Stage 8: Deploy to VAL
  # ========================================
  - stage: DeployVal
    displayName: 'Deploy to VAL'
    dependsOn: DeployQA
    condition: succeeded()
    jobs:
      - deployment: DeployValEnvironment
        displayName: 'Deploy VAL'
        environment: 'na-val-axon-cic'
        variables:
          - group: na-val-axon-cic
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self
                
                - download: current
                  artifact: actions-dist
                  displayName: 'Download CI Build Artifacts'

                - script: |
                    set -euo pipefail
                    mkdir -p actions/dist
                    cp -r "$(Pipeline.Workspace)/actions-dist/"* actions/dist/
                  displayName: 'Restore Actions Build'

                - task: TerraformInstaller@1
                  displayName: 'Install Terraform'
                  inputs:
                    terraformVersion: $(TF_VERSION)

                - script: |
                    set -euo pipefail
                    cd environments/val
                    
                    export AWS_ACCESS_KEY_ID="$(AWS_ACCESS_KEY_ID)"
                    export AWS_SECRET_ACCESS_KEY="$(AWS_SECRET_ACCESS_KEY)"
                    export AWS_DEFAULT_REGION="$(AWS_DEFAULT_REGION)"
                    
                    echo "========================================"
                    echo "Deploying to VAL: $(ENVIRONMENT_NAME)"
                    echo "========================================"
                    
                    terraform init \
                      -backend-config="bucket=$(TF_STATE_BUCKET)" \
                      -backend-config="key=terraform.tfstate" \
                      -backend-config="region=$(AWS_DEFAULT_REGION)" \
                      -backend-config="use_lockfile=true" \
                      -backend-config="encrypt=true" \
                      -input=false -no-color
                    
                    terraform plan \
                      -input=false -no-color -lock-timeout=5m \
                      -var-file=val.platform.tfvars.json \
                      -var="app_callbacks=$(app_callbacks)" \
                      -out=tfplan
                    
                    terraform show -json tfplan > "$(Build.ArtifactStagingDirectory)/val-plan.json"
                    terraform show -no-color tfplan > "$(Build.ArtifactStagingDirectory)/val-plan.txt"
                    
                    terraform apply -input=false -no-color -lock-timeout=5m -auto-approve tfplan
                    
                    terraform output -json > "$(Build.ArtifactStagingDirectory)/val-outputs.json"
                    
                    echo "✓ VAL deployment complete"
                    echo "========================================"
                  displayName: 'Deploy to VAL'
                  env:
                    TF_IN_AUTOMATION: '1'
                    AUTH0_DOMAIN: $(AUTH0_DOMAIN)
                    AUTH0_CLIENT_ID: $(AUTH0_CLIENT_ID)
                    AUTH0_CLIENT_SECRET: $(AUTH0_CLIENT_SECRET)
                    AWS_ACCESS_KEY_ID: $(AWS_ACCESS_KEY_ID)
                    AWS_SECRET_ACCESS_KEY: $(AWS_SECRET_ACCESS_KEY)
                    AWS_DEFAULT_REGION: $(AWS_DEFAULT_REGION)

                - publish: $(Build.ArtifactStagingDirectory)
                  artifact: val-artifacts
                  displayName: 'Publish VAL Artifacts'

  # ========================================
  # Stage 9: Deploy to PROD (Enterprise Best Practices)
  # ========================================
  - stage: DeployProd
    displayName: 'Deploy to PROD'
    dependsOn: DeployVal
    condition: succeeded()
    jobs:
      - deployment: DeployProdEnvironment
        displayName: 'Deploy PROD'
        environment: 'na-prod-axon-cic'
        variables:
          - group: na-prod-axon-cic
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self
                
                - download: current
                  artifact: actions-dist
                  displayName: 'Download CI Build Artifacts'

                - script: |
                    set -euo pipefail
                    mkdir -p actions/dist
                    cp -r "$(Pipeline.Workspace)/actions-dist/"* actions/dist/
                  displayName: 'Restore Actions Build'

                - task: TerraformInstaller@1
                  displayName: 'Install Terraform'
                  inputs:
                    terraformVersion: $(TF_VERSION)

                # Step 1: Terraform Init (Separate for PROD)
                - script: |
                    set -euo pipefail
                    
                    cd environments/prod
                    
                    export AWS_ACCESS_KEY_ID="$(AWS_ACCESS_KEY_ID)"
                    export AWS_SECRET_ACCESS_KEY="$(AWS_SECRET_ACCESS_KEY)"
                    export AWS_DEFAULT_REGION="$(AWS_DEFAULT_REGION)"
                    
                    echo "========================================"
                    echo "PRODUCTION DEPLOYMENT - INIT"
                    echo "========================================"
                    echo "Environment: $(ENVIRONMENT_NAME)"
                    echo "Deployment ID: $(Build.BuildNumber)"
                    echo "Triggered by: $(Build.RequestedFor)"
                    echo "========================================"
                    
                    terraform init \
                      -backend-config="bucket=$(TF_STATE_BUCKET)" \
                      -backend-config="key=terraform.tfstate" \
                      -backend-config="region=$(AWS_DEFAULT_REGION)" \
                      -backend-config="use_lockfile=true" \
                      -backend-config="encrypt=true" \
                      -input=false -no-color
                    
                    echo "✓ PROD initialized"
                  displayName: 'Step 1: Terraform Init'
                  env:
                    TF_IN_AUTOMATION: '1'
                    AUTH0_DOMAIN: $(AUTH0_DOMAIN)
                    AUTH0_CLIENT_ID: $(AUTH0_CLIENT_ID)
                    AUTH0_CLIENT_SECRET: $(AUTH0_CLIENT_SECRET)
                    AWS_ACCESS_KEY_ID: $(AWS_ACCESS_KEY_ID)
                    AWS_SECRET_ACCESS_KEY: $(AWS_SECRET_ACCESS_KEY)
                    AWS_DEFAULT_REGION: $(AWS_DEFAULT_REGION)

                # Step 2: Terraform Plan (Separate for PROD)
                - script: |
                    set -euo pipefail
                    
                    cd environments/prod
                    
                    export AWS_ACCESS_KEY_ID="$(AWS_ACCESS_KEY_ID)"
                    export AWS_SECRET_ACCESS_KEY="$(AWS_SECRET_ACCESS_KEY)"
                    export AWS_DEFAULT_REGION="$(AWS_DEFAULT_REGION)"
                    
                    echo "========================================"
                    echo "PRODUCTION DEPLOYMENT - PLAN"
                    echo "========================================"
                    
                    terraform plan \
                      -input=false \
                      -no-color \
                      -lock-timeout=5m \
                      -var-file=prod.platform.tfvars.json \
                      -var="app_callbacks=$(app_callbacks)" \
                      -out=tfplan
                    
                    echo ""
                    echo "Exporting plan for review..."
                    terraform show -json tfplan > "$(Build.ArtifactStagingDirectory)/prod-plan.json"
                    terraform show -no-color tfplan > "$(Build.ArtifactStagingDirectory)/prod-plan.txt"
                    
                    echo ""
                    echo "========================================"
                    echo "MANUAL CHECKPOINT"
                    echo "========================================"
                    echo "⚠ STOP: Review prod-plan.txt before approving"
                    echo "Next step will apply changes to PRODUCTION"
                    echo "========================================"
                  displayName: 'Step 2: Terraform Plan'
                  env:
                    TF_IN_AUTOMATION: '1'
                    AUTH0_DOMAIN: $(AUTH0_DOMAIN)
                    AUTH0_CLIENT_ID: $(AUTH0_CLIENT_ID)
                    AUTH0_CLIENT_SECRET: $(AUTH0_CLIENT_SECRET)
                    AWS_ACCESS_KEY_ID: $(AWS_ACCESS_KEY_ID)
                    AWS_SECRET_ACCESS_KEY: $(AWS_SECRET_ACCESS_KEY)
                    AWS_DEFAULT_REGION: $(AWS_DEFAULT_REGION)

                - publish: $(Build.ArtifactStagingDirectory)
                  artifact: prod-plan
                  displayName: 'Publish PROD Plan for Review'

                # Manual Approval Checkpoint (via Environment gate)
                # Reviewers must examine prod-plan.txt before approving

                # Step 3: Terraform Apply (Separate for PROD)
                - script: |
                    set -euo pipefail
                    
                    cd environments/prod
                    
                    export AWS_ACCESS_KEY_ID="$(AWS_ACCESS_KEY_ID)"
                    export AWS_SECRET_ACCESS_KEY="$(AWS_SECRET_ACCESS_KEY)"
                    export AWS_DEFAULT_REGION="$(AWS_DEFAULT_REGION)"
                    
                    echo "========================================"
                    echo "PRODUCTION DEPLOYMENT - APPLY"
                    echo "========================================"
                    echo "Applying approved changes to PRODUCTION..."
                    echo ""
                    
                    terraform apply \
                      -input=false \
                      -no-color \
                      -lock-timeout=5m \
                      -auto-approve \
                      tfplan
                    
                    echo ""
                    echo "========================================"
                    echo "✓ PRODUCTION DEPLOYMENT COMPLETE"
                    echo "========================================"
                  displayName: 'Step 3: Terraform Apply'
                  env:
                    TF_IN_AUTOMATION: '1'
                    AUTH0_DOMAIN: $(AUTH0_DOMAIN)
                    AUTH0_CLIENT_ID: $(AUTH0_CLIENT_ID)
                    AUTH0_CLIENT_SECRET: $(AUTH0_CLIENT_SECRET)
                    AWS_ACCESS_KEY_ID: $(AWS_ACCESS_KEY_ID)
                    AWS_SECRET_ACCESS_KEY: $(AWS_SECRET_ACCESS_KEY)
                    AWS_DEFAULT_REGION: $(AWS_DEFAULT_REGION)

                # Step 4: Capture Outputs
                - script: |
                    set -euo pipefail
                    
                    cd environments/prod
                    
                    export AWS_ACCESS_KEY_ID="$(AWS_ACCESS_KEY_ID)"
                    export AWS_SECRET_ACCESS_KEY="$(AWS_SECRET_ACCESS_KEY)"
                    export AWS_DEFAULT_REGION="$(AWS_DEFAULT_REGION)"
                    
                    terraform output -json > "$(Build.ArtifactStagingDirectory)/prod-outputs.json"
                    terraform output -no-color > "$(Build.ArtifactStagingDirectory)/prod-outputs.txt"
                  displayName: 'Step 4: Capture Outputs'
                  continueOnError: true
                  env:
                    AWS_ACCESS_KEY_ID: $(AWS_ACCESS_KEY_ID)
                    AWS_SECRET_ACCESS_KEY: $(AWS_SECRET_ACCESS_KEY)
                    AWS_DEFAULT_REGION: $(AWS_DEFAULT_REGION)

                - publish: $(Build.ArtifactStagingDirectory)
                  artifact: prod-outputs
                  displayName: 'Publish PROD Outputs'

                # Step 5: Post-Deployment Summary
                - script: |
                    set -euo pipefail
                    
                    echo "========================================"
                    echo "PRODUCTION DEPLOYMENT SUMMARY"
                    echo "========================================"
                    echo "Environment: $(ENVIRONMENT_NAME)"
                    echo "Deployment ID: $(Build.BuildNumber)"
                    echo "Completed: $(date -u)"
                    echo "Deployed by: $(Build.RequestedFor)"
                    echo "Terraform Version: $(TF_VERSION)"
                    echo "State Bucket: $(TF_STATE_BUCKET)"
                    echo "========================================"
                    echo ""
                    echo "Next Steps:"
                    echo "1. Verify Auth0 tenant functionality"
                    echo "2. Check application integrations"
                    echo "3. Monitor Auth0 logs for errors"
                    echo "4. Notify stakeholders"
                    echo ""
                    echo "Rollback: git revert + redeploy if issues"
                    echo "========================================"
                  displayName: 'Step 5: Deployment Summary'
